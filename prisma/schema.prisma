generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model School {
  id              String           @id @default(cuid())
  name            String
  subdomain       String           @unique
  domain          String?          @unique
  logo            String?
  primaryColor    String?          @default("#0ea5e9")
  secondaryColor  String?          @default("#10b981")
  address         String?
  phone           String?
  email           String?
  website         String?
  motto           String?
  description     String?
  settings        Json?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  academicYears   AcademicYear[]
  announcements   Announcement[]
  applications    Application[]
  classSubjects   ClassSubject[]
  classes         Class[]
  feeStructures   FeeStructure[]
  hostels         Hostel[]
  invoices        Invoice[]
  messages        Message[]
  staff           Staff[]
  students        Student[]
  subjects        Subject[]
  timetables      Timetable[]
  transportRoutes TransportRoute[]
  users           User[]

  @@index([subdomain])
  @@index([domain])
  @@map("schools")
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  password         String
  name             String
  phone            String?
  role             UserRole
  schoolId         String?
  isActive         Boolean   @default(true)
  emailVerified    DateTime?
  twoFactorEnabled Boolean   @default(false)
  twoFactorSecret  String?
  lastLogin        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  createdBy        String?
  accounts         Account[]
  parentProfile    Parent?
  sessions         Session[]
  staffProfile     Staff?
  studentProfile   Student?
  creator          User?     @relation("UserCreator", fields: [createdBy], references: [id])
  createdUsers     User[]    @relation("UserCreator")
  school           School?   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([schoolId, role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Student {
  id                         String             @id @default(cuid())
  studentNumber              String             @unique
  schoolId                   String
  userId                     String?            @unique
  firstName                  String
  lastName                   String
  middleName                 String?
  dateOfBirth                DateTime
  gender                     Gender
  photo                      String?
  nationalId                 String?
  birthCertNumber            String?
  curriculum                 Curriculum
  admissionDate              DateTime
  currentClassId             String?
  status                     StudentStatus      @default(ACTIVE)
  address                    String?
  phone                      String?
  email                      String?
  bloodGroup                 String?
  allergies                  String?
  medicalConditions          String?
  medicalRecords             Json?
  emergencyContacts          Json?
  previousSchool             String?
  previousGrade              String?
  transferReason             String?
  transportRouteId           String?
  isAlumni                   Boolean            @default(false)
  isBoarding                 Boolean            @default(false)
  createdAt                  DateTime           @default(now())
  updatedAt                  DateTime           @updatedAt
  createdBy                  String?
  updatedBy                  String?
  academicResults            Json?
  clubsInterests             String?
  documents                  Json?
  formerPrimaryGrade         String?
  formerPrimarySchool        String?
  formerPrimarySchoolAddress String?
  formerPrimarySchoolContact String?
  recreationalActivities     Json?
  specialTalents             String?
  academicYear               String?
  grade                      String?
  religion                   String?
  term                       String?
  applications               Application?
  attendance                 Attendance[]
  disciplineRecords          DisciplineRecord[]
  grades                     Grade[]
  hostelAllocation           HostelAllocation?
  parents                    ParentStudent[]
  reportCards                ReportCard[]
  account                    StudentAccount?
  currentClass               Class?             @relation("ClassStudents", fields: [currentClassId], references: [id])
  school                     School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  transportRoute             TransportRoute?    @relation(fields: [transportRouteId], references: [id])
  user                       User?              @relation(fields: [userId], references: [id])

  @@index([schoolId, studentNumber])
  @@index([schoolId, status])
  @@index([currentClassId])
  @@index([transportRouteId])
  @@map("students")
}

model Parent {
  id             String          @id @default(cuid())
  userId         String          @unique
  occupation     String?
  employer       String?
  workPhone      String?
  workAddress    String?
  address        String?
  alternatePhone String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  messages       Message[]       @relation("ParentMessages")
  students       ParentStudent[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments       Payment[]

  @@map("parents")
}

model ParentStudent {
  id               String   @id @default(cuid())
  parentId         String
  studentId        String
  relationship     String   @default("Parent")
  isPrimary        Boolean  @default(false)
  canPickup        Boolean  @default(true)
  emergencyContact Boolean  @default(true)
  createdAt        DateTime @default(now())
  parent           Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
  @@map("parent_students")
}

model Staff {
  id              String         @id @default(cuid())
  schoolId        String
  userId          String?        @unique
  employeeNumber  String         @unique
  firstName       String
  lastName        String
  middleName      String?
  dateOfBirth     DateTime?
  gender          Gender
  nationalId      String?
  photo           String?
  phone           String?
  email           String?
  address         String?
  employmentType  String
  position        String
  department      String?
  hireDate        DateTime
  terminationDate DateTime?
  salary          Decimal?       @db.Decimal(10, 2)
  qualifications  Json?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?
  updatedBy       String?
  subjectsTaught  ClassSubject[]
  classTeacher    Class[]        @relation("ClassTeacher")
  hostelManager   Hostel[]       @relation("HostelManager")
  messages        Message[]      @relation("StaffMessages")
  school          School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user            User?          @relation(fields: [userId], references: [id])
  timetables      Timetable[]

  @@index([schoolId, employeeNumber])
  @@index([schoolId, department])
  @@map("staff")
}

model AcademicYear {
  id            String         @id @default(cuid())
  schoolId      String
  name          String
  startDate     DateTime
  endDate       DateTime
  isCurrent     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  feeStructures FeeStructure[]
  grades        Grade[]
  reportCards   ReportCard[]
  terms         Term[]
  timetables    Timetable[]

  @@unique([schoolId, name])
  @@index([schoolId, isCurrent])
  @@map("academic_years")
}

model Term {
  id             String         @id @default(cuid())
  academicYearId String
  name           String
  startDate      DateTime
  endDate        DateTime
  isCurrent      Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  attendance     Attendance[]
  feeStructures  FeeStructure[]
  grades         Grade[]
  reportCards    ReportCard[]
  academicYear   AcademicYear   @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([academicYearId, name])
  @@index([academicYearId, isCurrent])
  @@map("terms")
}

model Class {
  id             String         @id @default(cuid())
  schoolId       String
  name           String
  level          String
  stream         String?
  curriculum     Curriculum
  capacity       Int            @default(30)
  room           String?
  classTeacherId String?
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  announcements  Announcement[]
  subjects       ClassSubject[]
  classTeacher   Staff?         @relation("ClassTeacher", fields: [classTeacherId], references: [id])
  school         School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  feeStructures  FeeStructure[]
  students       Student[]      @relation("ClassStudents")
  timetables     Timetable[]

  @@unique([schoolId, name])
  @@index([schoolId, level])
  @@map("classes")
}

model Subject {
  id           String         @id @default(cuid())
  schoolId     String
  code         String
  name         String
  curriculum   Curriculum
  description  String?
  category     String?
  isCore       Boolean        @default(true)
  isExaminable Boolean        @default(true)
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  classes      ClassSubject[]
  grades       Grade[]
  school       School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  timetables   Timetable[]

  @@unique([schoolId, code, curriculum])
  @@index([schoolId, curriculum])
  @@map("subjects")
}

model ClassSubject {
  id        String   @id @default(cuid())
  schoolId  String
  classId   String
  subjectId String
  teacherId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher   Staff?   @relation(fields: [teacherId], references: [id])

  @@unique([classId, subjectId])
  @@index([schoolId])
  @@map("class_subjects")
}

model Timetable {
  id             String       @id @default(cuid())
  schoolId       String
  academicYearId String
  classId        String
  subjectId      String
  teacherId      String
  dayOfWeek      Int
  startTime      String
  endTime        String
  room           String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  class          Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject        Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher        Staff        @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([schoolId, classId, dayOfWeek])
  @@index([teacherId, dayOfWeek])
  @@map("timetables")
}

model Attendance {
  id        String           @id @default(cuid())
  studentId String
  termId    String
  date      DateTime         @db.Date
  status    AttendanceStatus
  remarks   String?
  markedBy  String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  term      Term             @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([studentId, date])
  @@index([termId, date])
  @@map("attendance")
}

model Grade {
  id             String         @id @default(cuid())
  studentId      String
  subjectId      String
  academicYearId String
  termId         String
  assessmentType AssessmentType
  assessmentName String
  score          Decimal        @db.Decimal(5, 2)
  maxScore       Decimal        @default(100) @db.Decimal(5, 2)
  percentage     Decimal        @db.Decimal(5, 2)
  grade          String?
  gradePoint     Decimal?       @db.Decimal(3, 2)
  remarks        String?
  enteredBy      String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  academicYear   AcademicYear   @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  student        Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject        Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  term           Term           @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@index([studentId, academicYearId, termId])
  @@index([subjectId, academicYearId, termId])
  @@map("grades")
}

model ReportCard {
  id                  String       @id @default(cuid())
  studentId           String
  academicYearId      String
  termId              String
  totalMarks          Decimal?     @db.Decimal(7, 2)
  averagePercentage   Decimal?     @db.Decimal(5, 2)
  overallGrade        String?
  classPosition       Int?
  streamPosition      Int?
  classTeacherComment String?
  headTeacherComment  String?
  daysPresent         Int?
  daysAbsent          Int?
  isPublished         Boolean      @default(false)
  publishedAt         DateTime?
  publishedBy         String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  academicYear        AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  student             Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  term                Term         @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([studentId, academicYearId, termId])
  @@index([studentId, academicYearId])
  @@map("report_cards")
}

model DisciplineRecord {
  id               String           @id @default(cuid())
  studentId        String
  incidentDate     DateTime
  severity         IncidentSeverity
  incidentType     String
  description      String
  location         String?
  witnesses        String?
  actionTaken      String?
  parentNotified   Boolean          @default(false)
  parentNotifiedAt DateTime?
  reportedBy       String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  student          Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, incidentDate])
  @@map("discipline_records")
}

model FeeStructure {
  id             String        @id @default(cuid())
  schoolId       String
  academicYearId String
  termId         String?
  classId        String?
  name           String
  feeType        String
  curriculum     Curriculum?
  amount         Decimal       @db.Decimal(10, 2)
  dueDate        DateTime?
  lateFee        Decimal?      @db.Decimal(10, 2)
  description    String?
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  createdBy      String?
  academicYear   AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  class          Class?        @relation(fields: [classId], references: [id])
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  term           Term?         @relation(fields: [termId], references: [id])
  invoiceItems   InvoiceItem[]

  @@index([schoolId, academicYearId, feeType])
  @@map("fee_structures")
}

model StudentAccount {
  id                String        @id @default(cuid())
  studentId         String        @unique
  balance           Decimal       @default(0) @db.Decimal(10, 2)
  lastPaymentDate   DateTime?
  lastPaymentAmount Decimal?      @db.Decimal(10, 2)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  invoices          Invoice[]
  paymentPlans      PaymentPlan[]
  student           Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  transactions      Transaction[]

  @@map("student_accounts")
}

model Transaction {
  id               String          @id @default(cuid())
  studentAccountId String
  type             TransactionType
  amount           Decimal         @db.Decimal(10, 2)
  balanceBefore    Decimal         @db.Decimal(10, 2)
  balanceAfter     Decimal         @db.Decimal(10, 2)
  description      String
  reference        String?
  paymentMethod    PaymentMethod?
  proofOfPayment   String?
  bankReference    String?
  mobileMoneyRef   String?
  processedBy      String
  processedAt      DateTime        @default(now())
  notes            String?
  invoiceItemId    String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  payment          Payment?
  invoiceItem      InvoiceItem?    @relation(fields: [invoiceItemId], references: [id])
  studentAccount   StudentAccount  @relation(fields: [studentAccountId], references: [id], onDelete: Cascade)

  @@index([studentAccountId, processedAt])
  @@index([reference])
  @@index([type, processedAt])
  @@map("transactions")
}

model Invoice {
  id               String         @id @default(cuid())
  schoolId         String
  studentAccountId String
  invoiceNumber    String         @unique
  subtotal         Decimal        @db.Decimal(10, 2)
  discount         Decimal        @default(0) @db.Decimal(10, 2)
  total            Decimal        @db.Decimal(10, 2)
  amountPaid       Decimal        @default(0) @db.Decimal(10, 2)
  amountDue        Decimal        @db.Decimal(10, 2)
  issueDate        DateTime       @default(now())
  dueDate          DateTime
  status           InvoiceStatus  @default(DRAFT)
  notes            String?
  createdBy        String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  items            InvoiceItem[]
  school           School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentAccount   StudentAccount @relation(fields: [studentAccountId], references: [id], onDelete: Cascade)

  @@index([schoolId, invoiceNumber])
  @@index([studentAccountId, status])
  @@map("invoices")
}

model InvoiceItem {
  id             String        @id @default(cuid())
  invoiceId      String
  feeStructureId String?
  description    String
  quantity       Int           @default(1)
  unitPrice      Decimal       @db.Decimal(10, 2)
  amount         Decimal       @db.Decimal(10, 2)
  createdAt      DateTime      @default(now())
  feeStructure   FeeStructure? @relation(fields: [feeStructureId], references: [id])
  invoice        Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@map("invoice_items")
}

model Payment {
  id              String        @id @default(cuid())
  transactionId   String        @unique
  parentId        String?
  receiptNumber   String        @unique
  amount          Decimal       @db.Decimal(10, 2)
  paymentMethod   PaymentMethod
  proofOfPayment  String?
  bankReference   String?
  mobileMoneyRef  String?
  chequeNumber    String?
  status          String        @default("Pending")
  verifiedBy      String?
  verifiedAt      DateTime?
  rejectionReason String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  parent          Parent?       @relation(fields: [parentId], references: [id])
  transaction     Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([receiptNumber])
  @@index([parentId, createdAt])
  @@index([status])
  @@map("payments")
}

model PaymentPlan {
  id                   String                   @id @default(cuid())
  studentAccountId     String
  totalAmount          Decimal                  @db.Decimal(10, 2)
  numberOfInstallments Int
  installmentAmount    Decimal                  @db.Decimal(10, 2)
  startDate            DateTime
  status               String                   @default("Active")
  notes                String?
  approvedBy           String
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  installments         PaymentPlanInstallment[]
  studentAccount       StudentAccount           @relation(fields: [studentAccountId], references: [id], onDelete: Cascade)

  @@index([studentAccountId, status])
  @@map("payment_plans")
}

model PaymentPlanInstallment {
  id                String      @id @default(cuid())
  paymentPlanId     String
  installmentNumber Int
  amount            Decimal     @db.Decimal(10, 2)
  dueDate           DateTime
  paidDate          DateTime?
  paidAmount        Decimal?    @db.Decimal(10, 2)
  status            String      @default("Pending")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  paymentPlan       PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@unique([paymentPlanId, installmentNumber])
  @@map("payment_plan_installments")
}

model Hostel {
  id          String             @id @default(cuid())
  schoolId    String
  name        String
  gender      Gender
  capacity    Int
  managerId   String?
  description String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  blocks      HostelBlock[]
  fees        HostelFee[]
  inspections HostelInspection[]
  manager     Staff?             @relation("HostelManager", fields: [managerId], references: [id])
  school      School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("hostels")
}

model HostelBlock {
  id          String       @id @default(cuid())
  hostelId    String
  name        String
  floor       Int?
  capacity    Int
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  hostel      Hostel       @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  rooms       HostelRoom[]

  @@unique([hostelId, name])
  @@map("hostel_blocks")
}

model HostelRoom {
  id         String      @id @default(cuid())
  blockId    String
  roomNumber String
  capacity   Int         @default(4)
  roomType   String?
  hasEnsuite Boolean     @default(false)
  isActive   Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  beds       HostelBed[]
  block      HostelBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@unique([blockId, roomNumber])
  @@map("hostel_rooms")
}

model HostelBed {
  id          String            @id @default(cuid())
  roomId      String
  bedNumber   String
  bedType     String?
  isAvailable Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  allocation  HostelAllocation?
  room        HostelRoom        @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, bedNumber])
  @@map("hostel_beds")
}

model HostelAllocation {
  id           String    @id @default(cuid())
  studentId    String    @unique
  bedId        String    @unique
  checkInDate  DateTime
  checkOutDate DateTime?
  isActive     Boolean   @default(true)
  allocatedBy  String
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  bed          HostelBed @relation(fields: [bedId], references: [id])
  student      Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([bedId])
  @@map("hostel_allocations")
}

model HostelFee {
  id           String   @id @default(cuid())
  hostelId     String
  name         String
  amount       Decimal  @db.Decimal(10, 2)
  term         String?
  academicYear String
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  hostel       Hostel   @relation(fields: [hostelId], references: [id], onDelete: Cascade)

  @@index([hostelId, academicYear])
  @@map("hostel_fees")
}

model HostelInspection {
  id               String    @id @default(cuid())
  hostelId         String
  inspectionDate   DateTime
  inspectedBy      String
  cleanlinessScore Int?
  maintenanceScore Int?
  safetyScore      Int?
  overallScore     Int?
  findings         String?
  recommendations  String?
  followUpDate     DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  hostel           Hostel    @relation(fields: [hostelId], references: [id], onDelete: Cascade)

  @@index([hostelId, inspectionDate])
  @@map("hostel_inspections")
}

model Application {
  id                   String            @id @default(cuid())
  schoolId             String
  applicationNumber    String            @unique
  firstName            String
  lastName             String
  middleName           String?
  dateOfBirth          DateTime
  gender               Gender
  nationalId           String?
  birthCertNumber      String?
  email                String?
  phone                String?
  address              String?
  curriculum           Curriculum
  applyingForClass     String
  previousSchool       String?
  previousGrade        String?
  guardianInfo         Json
  documents            Json?
  birthCertificate     String?
  previousReports      String?
  photo                String?
  medicalRecords       String?
  applicationFee       Decimal?          @db.Decimal(10, 2)
  applicationFeePaid   Boolean           @default(false)
  paymentReference     String?
  status               ApplicationStatus @default(DRAFT)
  submittedAt          DateTime?
  reviewedBy           String?
  reviewedAt           DateTime?
  reviewNotes          String?
  interviewDate        DateTime?
  interviewNotes       String?
  decisionDate         DateTime?
  decisionBy           String?
  rejectionReason      String?
  convertedToStudentId String?           @unique
  convertedAt          DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  student              Student?          @relation(fields: [convertedToStudentId], references: [id])
  school               School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId, status])
  @@index([applicationNumber])
  @@index([schoolId, createdAt])
  @@map("applications")
}

model TransportRoute {
  id               String    @id @default(cuid())
  schoolId         String
  routeName        String
  routeDescription String?
  pickupPoints     Json?
  vehicleNumber    String?
  vehicleType      String?
  driverId         String?
  assistantId      String?
  driverPhone      String?
  capacity         Int
  fee              Decimal   @db.Decimal(10, 2)
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  students         Student[]
  school           School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("transport_routes")
}

model Announcement {
  id             String    @id @default(cuid())
  schoolId       String
  title          String
  content        String
  targetAudience String
  targetClassId  String?
  isUrgent       Boolean   @default(false)
  isPinned       Boolean   @default(false)
  sendSMS        Boolean   @default(false)
  sendEmail      Boolean   @default(false)
  publishDate    DateTime  @default(now())
  expiryDate     DateTime?
  attachments    Json?
  createdBy      String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  school         School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  targetClass    Class?    @relation(fields: [targetClassId], references: [id])

  @@index([schoolId, publishDate])
  @@index([targetAudience])
  @@map("announcements")
}

model Message {
  id              String    @id @default(cuid())
  schoolId        String
  senderId        String
  senderType      String
  recipientId     String
  recipientType   String
  parentId        String?
  staffId         String?
  subject         String?
  content         String
  attachments     Json?
  isRead          Boolean   @default(false)
  readAt          DateTime?
  parentMessageId String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  parent          Parent?   @relation("ParentMessages", fields: [parentId], references: [id])
  parentMessage   Message?  @relation("MessageThread", fields: [parentMessageId], references: [id])
  replies         Message[] @relation("MessageThread")
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  staff           Staff?    @relation("StaffMessages", fields: [staffId], references: [id])

  @@index([schoolId, senderId])
  @@index([schoolId, recipientId])
  @@index([parentId])
  @@index([staffId])
  @@map("messages")
}

model AuditLog {
  id         String   @id @default(cuid())
  schoolId   String?
  userId     String
  action     String
  entityType String
  entityId   String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([schoolId, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  ACCOUNTANT
  REGISTRAR
  TEACHER
  HOSTEL_MANAGER
  PARENT
  STUDENT
}

enum Curriculum {
  ZIMSEC
  CAMBRIDGE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum StudentStatus {
  ACTIVE
  GRADUATED
  TRANSFERRED
  SUSPENDED
  EXPELLED
  WITHDRAWN
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  SICK
}

enum AssessmentType {
  CLASSWORK
  HOMEWORK
  TEST
  QUIZ
  MID_TERM_EXAM
  END_TERM_EXAM
  PROJECT
  PRACTICAL
  ORAL
}

enum IncidentSeverity {
  MINOR
  MODERATE
  MAJOR
  SEVERE
}

enum TransactionType {
  CHARGE
  PAYMENT
  ADJUSTMENT
  REFUND
  WAIVER
  DISCOUNT
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  ECOCASH
  INNBUCKS
  PAYNOW
  CHEQUE
  CARD
  OTHER
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  VOIDED
}

enum ApplicationStatus {
  DRAFT
  PENDING
  UNDER_REVIEW
  DOCUMENTS_REQUIRED
  INTERVIEW_SCHEDULED
  APPROVED
  REJECTED
  WAITLISTED
  ENROLLED
  WITHDRAWN
}
